# Исправление: Почему пользователь возвращается через payment_cancel

## Проблема

В логах указано, что пользователь вернулся через `payment_cancel`, даже если платеж был успешен. Это происходит потому, что YooKassa использует `return_url` для возврата пользователя в бота, и этот URL всегда содержит параметр `payment_cancel`, независимо от того, успешна ли оплата или отменена.

## Причина

YooKassa имеет два URL:
- `success_url` - используется при успешной оплате (но не всегда)
- `return_url` - используется при возврате пользователя (используется чаще)

Проблема в том, что `return_url` всегда содержит `payment_cancel`, даже если платеж был успешен. Это происходит потому, что:
1. Пользователь может просто закрыть окно оплаты
2. Пользователь может вернуться в бота другим способом
3. YooKassa использует `return_url` как основной способ возврата пользователя

## Решение

Изменена логика обработки возврата пользователя после оплаты:

1. **Не полагаться на параметр `payment_cancel` или `payment_success`**
   - Теперь при любом возврате после оплаты (и `payment_success`, и `payment_cancel`) бот проверяет статус последнего платежа
   - Статус проверяется независимо от параметра в URL

2. **Всегда проверять статус последнего платежа**
   - Сначала проверяется статус в базе данных
   - Если статус 'succeeded', платеж обрабатывается как успешный
   - Если статус 'pending' или 'canceled', проверяется через API YooKassa
   - Если через API статус 'succeeded', платеж обрабатывается как успешный

3. **Улучшено логирование**
   - Теперь в логах видно, что пользователь вернулся после оплаты, независимо от параметра
   - Логируется статус платежа, найденный в базе и через API

## Результат

Теперь бот правильно обрабатывает успешные платежи, даже если пользователь возвращается через `payment_cancel`, потому что:
- Бот не полагается на параметр URL
- Бот всегда проверяет фактический статус платежа в базе данных и через API
- Если платеж успешен, он обрабатывается как успешный, независимо от параметра URL

## Изменения в коде

- Объединена обработка `payment_success` и `payment_cancel` в один блок
- Добавлена проверка статуса последнего платежа при любом возврате после оплаты
- Удален старый код, который полагался только на параметр URL

