# Исправление автоматической генерации натальной карты после оплаты

## Проблема

После успешной оплаты бот показывал сообщение "Оплата получена! Обрабатываю платеж... Пожалуйста, подождите немного. Если натальная карта не начнет генерироваться автоматически, нажмите кнопку ниже." вместо того, чтобы сразу запускать генерацию.

## Причина

Логика обработки платежей полагалась на функцию `check_and_process_pending_payment`, которая:
1. Ищет только `pending` платежи или `succeeded` платежи, для которых еще нет события `payment_success`
2. Если платеж уже обработан через webhook YooKassa, событие `payment_success` уже записано
3. Поэтому функция возвращала `False`, и генерация не запускалась автоматически

## Решение

Изменена логика в функции `start` при обработке возврата пользователя после оплаты:

1. **Убран вызов `check_and_process_pending_payment` в начале** - он мог возвращать `False` даже для успешных платежей, если они уже обработаны через webhook

2. **Добавлена прямая проверка статуса платежа**:
   - Если платеж уже `succeeded` в базе → проверяем профиль и запускаем генерацию
   - Если платеж `pending` или `canceled` → проверяем через API YooKassa
   - Если после проверки через API платеж `succeeded` → запускаем генерацию

3. **Генерация запускается автоматически**, если:
   - Платеж имеет статус `succeeded`
   - Профиль пользователя заполнен (есть `birth_name`, `birth_date`, `birth_time`, `birth_place`)

4. **Если профиль не заполнен**, показывается сообщение с кнопкой для заполнения профиля

## Измененные места в коде

- Строки 729-793: Упрощена логика обработки возврата после оплаты
- Строки 805-836: Добавлена проверка профиля и автоматический запуск генерации после проверки платежа через API

## Результат

Теперь после успешной оплаты, если профиль пользователя заполнен, генерация натальной карты запускается автоматически, без необходимости нажимать кнопку.

