# Почему возврат в бота всегда через payment_cancel?

## Ответ: Это комбинация логики YooKassa и настройки бота

### 1. Логика YooKassa

YooKassa использует **один URL** для возврата пользователя в бота - это `return_url`. Этот URL используется **ВСЕГДА**, когда пользователь возвращается из окна оплаты, **независимо от того, успешна ли оплата или отменена**.

**Важно понимать:**
- YooKassa НЕ имеет отдельного механизма для разных URL при успешной/неуспешной оплате
- `return_url` - это единственный URL, который используется для возврата пользователя
- Параметр `success_url` существует, но он **не используется** в типе подтверждения "redirect"

### 2. Настройка бота

В коде бота (строки 2311-2313) `return_url` устанавливается так:

```python
if return_url_env:
    return_url = return_url_env  # Если указан в переменных окружения
elif bot_username:
    return_url = f'https://t.me/{bot_username}?start=payment_cancel'
else:
    return_url = 'https://t.me/your_bot?start=payment_cancel'
```

**Почему `payment_cancel`?**
- Это просто соглашение/название параметра
- Бот мог бы использовать любой параметр, например `payment_return` или даже без параметра
- Исторически было решено использовать `payment_cancel`, чтобы отличать возврат от обычного `/start`

### 3. Почему это не проблема?

Хотя URL содержит `payment_cancel`, бот **не полагается** на этот параметр для определения статуса платежа. Вместо этого:

1. Бот всегда проверяет **фактический статус** последнего платежа в базе данных
2. Если статус `succeeded` - обрабатывает как успешный
3. Если статус `pending` или `canceled` - проверяет через API YooKassa
4. Сообщение об отмене показывается **только** если платеж действительно отменен

### 4. Можно ли изменить?

Да, можно использовать любой параметр, например:
- `payment_return` - более нейтральное название
- Без параметра вообще - просто `/start`

Но это не имеет значения, так как бот не полагается на параметр для определения статуса платежа.

## Итог

**Это логика YooKassa** - они используют один `return_url` для возврата пользователя, независимо от результата оплаты.

**Настройка бота** - использование параметра `payment_cancel` - это просто соглашение, которое не влияет на обработку платежей.

**Важно:** Бот правильно обрабатывает успешные платежи, даже если возврат через `payment_cancel`, потому что проверяет фактический статус платежа, а не параметр URL.

