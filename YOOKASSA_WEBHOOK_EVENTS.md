# Настройка событий webhook в YooKassa

## Текущая конфигурация

В боте используется **автоматическое подтверждение платежей** (`capture: True`), поэтому события webhook настроены следующим образом:

### Рекомендуемые события для включения:

✅ **payment.succeeded** - Успешная оплата
- ОБЯЗАТЕЛЬНО включено
- Обрабатывается в коде: `event_type == 'payment.succeeded'`
- Бот обрабатывает успешные платежи и запускает генерацию натальной карты

✅ **payment.canceled** - Отмена платежа
- ОБЯЗАТЕЛЬНО включено
- Обрабатывается в коде: `event_type == 'payment.canceled'`
- Бот логирует причину отмены

### Необязательные события:

❌ **payment.waiting_for_capture** - Платеж ожидает подтверждения
- НЕ нужно включать (если используется автоматическое подтверждение)
- Это событие приходит только при ручном подтверждении (`capture: False`)
- Так как используется `capture: True`, платеж сразу переходит в `succeeded`
- Если включить, бот не будет обрабатывать это событие (нет обработчика в коде)

❌ **refund.succeeded** - Успешный возврат
- НЕ нужно включать (если не планируется возврат средств)
- Обработчик этого события отсутствует в коде

## Что происходит при автоматическом подтверждении

1. Пользователь оплачивает → YooKassa создает платеж со статусом `pending`
2. Пользователь успешно оплачивает → YooKassa отправляет webhook `payment.succeeded`
3. Бот получает `payment.succeeded` → обновляет статус в БД → запускает генерацию натальной карты

## Если переключиться на ручное подтверждение

Если в будущем понадобится ручное подтверждение (`capture: False`):

1. Изменить в коде: `"capture": False`
2. Включить событие `payment.waiting_for_capture` в настройках YooKassa
3. Добавить обработчик в `bot.py`:
```python
elif event_type == 'payment.waiting_for_capture':
    # Обработка платежа, ожидающего подтверждения
    # Например, отправить уведомление администратору для ручного подтверждения
```

## Текущие настройки webhook

- URL: `https://nikroshchin1894-astral-bot-e77d.twc1.net/webhook/yookassa`
- Включено: `payment.succeeded`, `payment.canceled`
- Не включено: `payment.waiting_for_capture`, `refund.succeeded`

Эти настройки оптимальны для текущей конфигурации бота.

