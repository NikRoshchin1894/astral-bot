# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ Telegram –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–ø–ª–∞—Ç—ã

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ 409 Conflict

```
telegram.error.Conflict: Conflict: terminated by other getUpdates request; 
make sure that only one bot instance is running
```

–≠—Ç–∞ –æ—à–∏–±–∫–∞ –æ–∑–Ω–∞—á–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç –º–µ–∂–¥—É webhook –∏ polling —Ä–µ–∂–∏–º–∞–º–∏.

## üîç –ü—Ä–∏—á–∏–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞

1. **Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–æ –±–æ—Ç –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å polling**
   - `TELEGRAM_WEBHOOK_URL` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–æ webhook –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ Telegram
   - –ë–æ—Ç –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å polling, —á—Ç–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å webhook

2. **–ó–∞–ø—É—â–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –±–æ—Ç–∞**
   - –ù–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞ –ø—ã—Ç–∞—é—Ç—Å—è –ø–æ–ª—É—á–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

3. **–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å–µ—Å—Å–∏—è –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞**
   - –°—Ç–∞—Ä—ã–π –ø—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞ –≤—Å–µ –µ—â–µ –∞–∫—Ç–∏–≤–µ–Ω

## ‚úÖ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Webhook —Ä–µ–∂–∏–º (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

–ï—Å–ª–∏ —É –≤–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω `TELEGRAM_WEBHOOK_URL`, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ webhook —Ä–µ–∂–∏–º:

1. **–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ webhook —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω:**
   ```bash
   python check_all_webhooks.py
   ```

2. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:**
   ```bash
   # –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
   sudo systemctl start astral-bot
   # –∏–ª–∏
   python bot.py
   ```

3. **–ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç webhook** –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏** - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
   ```
   üåê –ó–∞–ø—É—Å–∫ webhook —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ 0.0.0.0:8080
   üîó –£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook –≤ Telegram...
   ‚úÖ Webhook —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ Telegram
   ```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Polling —Ä–µ–∂–∏–º

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å polling –≤–º–µ—Å—Ç–æ webhook:

1. **–£–¥–∞–ª–∏—Ç–µ webhook:**
   ```bash
   python remove_webhook.py
   ```

2. **–£–¥–∞–ª–∏—Ç–µ –∏–ª–∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ TELEGRAM_WEBHOOK_URL:**
   ```bash
   # –í .env —Ñ–∞–π–ª–µ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ:
   # TELEGRAM_WEBHOOK_URL=https://...
   ```

3. **–û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤—Å–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –±–æ—Ç–∞:**
   ```bash
   # –ù–∞–π—Ç–∏ –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
   ps aux | grep bot.py
   
   # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ (–∑–∞–º–µ–Ω–∏—Ç–µ PID –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ)
   kill <PID>
   ```

4. **–ü–æ–¥–æ–∂–¥–∏—Ç–µ 1-2 –º–∏–Ω—É—Ç—ã**

5. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:**
   ```bash
   python bot.py
   ```

## üöÄ –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –®–∞–≥ 1: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

```bash
python fix_telegram_conflict.py
```

–°–∫—Ä–∏–ø—Ç –ø–æ–∫–∞–∂–µ—Ç:
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ webhook
- –ï—Å—Ç—å –ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç
- –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å

### –®–∞–≥ 2: –£–¥–∞–ª–∏—Ç—å webhook (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ polling)

```bash
python remove_webhook.py
```

### –®–∞–≥ 3: –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞

```bash
# –ù–∞–π—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å—ã
ps aux | grep bot.py

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
sudo systemctl stop astral-bot
# –∏–ª–∏
pkill -f bot.py
```

### –®–∞–≥ 4: –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –∑–∞–Ω–æ–≤–æ

**–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ webhook:**
```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
sudo systemctl start astral-bot
```

**–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ polling:**
```bash
python bot.py
```

## üí≥ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–ø–ª–∞—Ç—ã –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞

–ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã:**
   ```bash
   python check_payment_readiness.py
   ```

2. **–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ webhook –¥–æ—Å—Ç—É–ø–µ–Ω:**
   ```bash
   python check_all_webhooks.py
   ```

3. **–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ webhook –≤ YooKassa:**
   - –í–æ–π–¥–∏—Ç–µ –≤ [–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç YooKassa](https://yookassa.ru/my)
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
   - –î–æ–±–∞–≤—å—Ç–µ: `https://nikroshchin1894-astral-bot-e77d.twc1.net/webhook/yookassa`
   - –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è: `payment.succeeded`, `payment.canceled`

4. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –æ–ø–ª–∞—Ç—É**

## üìã –ß–µ–∫-–ª–∏—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

- [ ] –ó–∞–ø—É—â–µ–Ω —Å–∫—Ä–∏–ø—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: `python fix_telegram_conflict.py`
- [ ] Webhook —É–¥–∞–ª–µ–Ω (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ polling): `python remove_webhook.py`
- [ ] –í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- [ ] –ü–æ–¥–æ–∂–¥–∞–ª–∏ 1-2 –º–∏–Ω—É—Ç—ã
- [ ] –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∑–∞–Ω–æ–≤–æ
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –ª–æ–≥–∏ - –Ω–µ—Ç –æ—à–∏–±–æ–∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –æ–ø–ª–∞—Ç—ã: `python check_payment_readiness.py`

## üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞

```bash
# –ù–∞–π—Ç–∏ –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
ps aux | grep bot.py

# –ù–∞–π—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å—ã –ø–æ –ø–æ—Ä—Ç—É (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è webhook)
lsof -i :8080

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
pkill -f bot.py
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ webhook

```bash
python check_bot_status.py
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ —á–µ—Ä–µ–∑ API

```bash
# –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–ª—É—á–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
curl "https://api.telegram.org/bot<YOUR_TOKEN>/getUpdates?offset=-1&limit=1"

# –ï—Å–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç–µ 409 - –µ—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç
# –ï—Å–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç–µ 200 - –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –Ω–µ—Ç
```

## üí° –í–∞–∂–Ω–æ –∑–Ω–∞—Ç—å

### –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞

1. **Webhook —Ä–µ–∂–∏–º** (–∫–æ–≥–¥–∞ `TELEGRAM_WEBHOOK_URL` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω):
   - Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä
   - –¢—Ä–µ–±—É–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
   - –ë—ã—Å—Ç—Ä–µ–µ –∏ –Ω–∞–¥–µ–∂–Ω–µ–µ
   - **–ù—É–∂–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ webhook**

2. **Polling —Ä–µ–∂–∏–º** (–∫–æ–≥–¥–∞ `TELEGRAM_WEBHOOK_URL` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω):
   - –ë–æ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
   - –†–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ (–¥–∞–∂–µ –ª–æ–∫–∞–ª—å–Ω–æ)
   - –ú–µ–¥–ª–µ–Ω–Ω–µ–µ
   - **–û–ø–ª–∞—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É (–∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã)**

### –ß—Ç–æ –≤—ã–±—Ä–∞—Ç—å?

**–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Å –æ–ø–ª–∞—Ç–æ–π:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **WEBHOOK —Ä–µ–∂–∏–º**
- ‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ webhook —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω
- ‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ webhook –≤ YooKassa

**–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏/—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **POLLING —Ä–µ–∂–∏–º**
- ‚úÖ –£–¥–∞–ª–∏—Ç–µ webhook: `python remove_webhook.py`
- ‚úÖ –û–ø–ª–∞—Ç–∞ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É

## üìû –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–ª–æ

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±–æ—Ç–∞ –Ω–∞ –æ—à–∏–±–∫–∏
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–µ–∂–∏–º (webhook –ò–õ–ò polling)
3. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ 5 –º–∏–Ω—É—Ç
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
5. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)

---

**–ì–ª–∞–≤–Ω–æ–µ**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –û–î–ò–ù —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã - –ª–∏–±–æ webhook, –ª–∏–±–æ polling! üöÄ

