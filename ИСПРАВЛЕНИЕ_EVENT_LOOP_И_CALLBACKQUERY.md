# Исправление ошибки Event loop is closed и отсутствующего chat_instance

## Проблема

После успешной оплаты при попытке запустить генерацию натальной карты возникали ошибки:
1. `__init__() missing 1 required positional argument: 'chat_instance'` - при создании фиктивного CallbackQuery
2. `RuntimeError('Event loop is closed')` - при попытке использовать event loop после его закрытия

## Причина

Функция `handle_natal_chart_request_from_payment` пыталась создать фиктивный объект `CallbackQuery` для вызова `handle_natal_chart_request`, но:
1. Не указывала обязательный параметр `chat_instance` при создании `CallbackQuery`
2. Создание фиктивных объектов могло приводить к проблемам с event loop, особенно при вызове из webhook handler в отдельном потоке

## Решение

Полностью переписана функция `handle_natal_chart_request_from_payment`:

1. **Убрано создание фиктивного CallbackQuery** - теперь функция работает напрямую с данными пользователя и context
2. **Прямой вызов генерации** - функция напрямую подготавливает данные и запускает `generate_natal_chart_background`
3. **Правильная инициализация active_generations** - перед вызовом `generate_natal_chart_background` создается запись в `active_generations` с правильными данными (chat_id, message_id, birth_data, openai_key)
4. **Правильная работа с сообщениями** - используется `bot.send_message` для отправки сообщения о начале генерации и получения `message_id`

### Изменения:

- Функция загружает данные пользователя из контекста или базы данных
- Проверяет наличие всех необходимых полей профиля
- Логирует начало генерации
- Отправляет сообщение о начале генерации и получает `message_id`
- Добавляет запись в `active_generations` с правильными данными
- Запускает генерацию через `asyncio.create_task(generate_natal_chart_background(user_id, context))`

### Преимущества:

- Нет проблем с event loop - используется существующий event loop из context
- Нет проблем с созданием фиктивных объектов - работаем напрямую с данными
- Более простая и понятная логика
- Правильная обработка ошибок

## Измененные места в коде

- Строки 2942-3021: Полностью переписана функция `handle_natal_chart_request_from_payment`

## Результат

Теперь после успешной оплаты генерация натальной карты запускается автоматически без ошибок, связанных с event loop или созданием фиктивных объектов.

