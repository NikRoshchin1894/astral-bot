# Исправление: Бот показывает "Оплата отменена" при успешной оплате

## Проблема

Бот показывал сообщение "❌ Оплата отменена" даже когда платеж был успешно оплачен через YooKassa. Это происходило, когда:

1. Пользователь возвращался к боту после оплаты через параметр `payment_cancel`
2. Webhook от YooKassa еще не пришел или пришел с задержкой
3. Статус платежа в базе данных был 'pending' или 'canceled', хотя фактически платеж был успешен

## Причина

Когда пользователь возвращался к боту после оплаты (даже успешной), он мог попасть в обработчик `payment_cancel`. Бот проверял статус последнего платежа в базе данных. Если статус был 'pending' или 'canceled', бот проверял статус через API YooKassa, но **не обрабатывал случай, когда проверка через API показывала, что платеж успешен ('succeeded')**.

Также проблема могла возникнуть, если:
- Webhook от YooKassa приходил с задержкой
- Пользователь возвращался к боту раньше, чем webhook обрабатывался
- Статус в базе данных еще не был обновлен

## Решение

Добавлена проверка статуса платежа через API YooKassa при возврате пользователя после оплаты. Если проверка показывает, что платеж успешен ('succeeded'), бот:

1. Обновляет статус платежа в базе данных
2. Помечает пользователя как оплатившего
3. Обрабатывает платеж как успешный (запускает генерацию натальной карты)
4. **НЕ показывает сообщение об отмене**

### Изменения в коде

1. **Добавлена обработка случая 'succeeded' при проверке через API:**
   ```python
   if payment_status == 'succeeded':
       logger.info(f"✅ Платеж {payment_id} успешен при проверке через API после payment_cancel")
       # Обновляем статус в базе
       update_payment_status(payment_id, 'succeeded', payment_info_api)
       # Помечаем пользователя как оплатившего
       mark_user_paid(user_id)
       # Обрабатываем платеж как успешный
       payment_processed = await check_and_process_pending_payment(user_id, context)
       if payment_processed:
           return  # Не показываем сообщение об отмене
   ```

2. **Добавлена обработка случая, когда статус в базе уже 'succeeded':**
   ```python
   elif payment_status == 'succeeded':
       # Платеж уже успешен в базе - обрабатываем его
       logger.info(f"✅ Платеж {payment_id} уже успешен в базе, обрабатываем его")
       payment_processed = await check_and_process_pending_payment(user_id, context)
       if payment_processed:
           return  # Не показываем сообщение об отмене
   ```

3. **Улучшена логика проверки статуса:**
   - Теперь проверка через API выполняется для платежей в статусе 'pending' или 'canceled'
   - Если проверка показывает 'succeeded', платеж обрабатывается как успешный
   - Сообщение об отмене показывается только если платеж действительно отменен

## Результат

Теперь бот правильно обрабатывает успешные платежи даже если:
- Webhook от YooKassa еще не пришел
- Пользователь возвращается через параметр `payment_cancel`
- Статус в базе данных еще не обновлен

Если платеж успешен, бот не будет показывать сообщение об отмене, а вместо этого:
- Обновит статус платежа в базе
- Пометит пользователя как оплатившего
- Обработает платеж (запустит генерацию натальной карты)

## Проверка

После обновления кода:
1. Обновить код на сервере: `git pull origin main`
2. Перезапустить бота: `sudo systemctl restart astral-bot`
3. Протестировать: создать тестовый платеж и вернуться к боту после оплаты

